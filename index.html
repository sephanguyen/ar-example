<!DOCTYPE html>

<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>Hello, AR Cubes!</title>
	<!-- include three.js library -->
	<script src='js/three.js'></script>
	<script src='js/MTLLoader.js'></script>
	<script src='js/OBJLoader.js'></script>
	<!-- include jsartookit -->
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>
	<!-- include sphereViewer -->
	<script src="js/uevent.min.js"></script>
	<script src="js/doT.min.js"></script>
	<script src="js/sphereViewer/photo-sphere-viewer.min.js"></script>
	<link rel="stylesheet" href="js/sphereViewer/photo-sphere-viewer.min.css">

	<style>
		body {
			overflow: hidden;
			margin: 0;
		}

		.ui {
			position: absolute;
		}

		#viewer {
			width: 100vw;
			height: 98vh;
			z-index: 1;
		}
	</style>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

	<!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->

	<script>


		var scene, camera, renderer, clock, deltaTime, totalTime;

		var arToolkitSource, arToolkitContext;

		var markerRoot1, markerRoot2;

		var mesh1, viewer;

		initialize();
		animate();

		function initialize() {
			scene = new THREE.Scene();

			let ambientLight = new THREE.AmbientLight(0xcccccc, 0.5);
			scene.add(ambientLight);

			camera = new THREE.Camera();
			scene.add(camera);

			renderer = new THREE.WebGLRenderer({
				antialias: true,
				alpha: true
			});
			renderer.setClearColor(new THREE.Color('lightgrey'), 0)
			renderer.setSize(640, 480);
			renderer.domElement.style.position = 'absolute'
			renderer.domElement.style.top = '0px'
			renderer.domElement.style.left = '0px'
			document.body.appendChild(renderer.domElement);

			clock = new THREE.Clock();
			deltaTime = 0;
			totalTime = 0;

			////////////////////////////////////////////////////////////
			// setup arToolkitSource
			////////////////////////////////////////////////////////////

			arToolkitSource = new THREEx.ArToolkitSource({
				sourceType: 'webcam',
			});

			function onResize() {
				arToolkitSource.onResize()
				arToolkitSource.copySizeTo(renderer.domElement)
				if (arToolkitContext.arController !== null) {
					arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)
				}
			}

			arToolkitSource.init(function onReady() {
				onResize()
			});

			// handle resize event
			window.addEventListener('resize', function () {
				onResize()
			});

			////////////////////////////////////////////////////////////
			// setup arToolkitContext
			////////////////////////////////////////////////////////////	

			// create atToolkitContext
			arToolkitContext = new THREEx.ArToolkitContext({
				cameraParametersUrl: 'data/camera_para.dat',
				detectionMode: 'mono'
			});

			// copy projection matrix to camera when initialization complete
			arToolkitContext.init(function onCompleted() {
				camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
			});

			////////////////////////////////////////////////////////////
			// setup markerRoots
			////////////////////////////////////////////////////////////

			let patternArray = ["letterA", "letterB", "letterC", "letterD", "letterF", "kanji", "hiro"];
			let colorArray = [0xff0000, 0xff8800, 0xffff00, 0x00cc00, 0x0000ff, 0xcc00ff, 0xcccccc];
			for (let i = 0; i < 7; i++) {
				let markerRoot = new THREE.Group();
				scene.add(markerRoot);
				let markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
					type: 'pattern', patternUrl: "data/" + patternArray[i] + ".patt",
				});

				let geometry = new THREE.PlaneBufferGeometry(1, 1, 4, 4);
				let loader = new THREE.TextureLoader();
				// let texture = loader.load( 'images/earth.jpg', render );
				let material = new THREE.MeshBasicMaterial({ color: 0x0000ff, opacity: 0.5 });
				let mesh = new THREE.Mesh(geometry, material);
				mesh.rotation.x = -Math.PI / 2;
				markerRoot.add(mesh);

				new THREE.MTLLoader()
					.setTexturePath('models/rose/')
					.setPath('models/rose/')
					.load('rose.mtl', function (materials) {
						materials.preload();
						new THREE.OBJLoader()
							.setMaterials(materials)
							.setPath('models/rose/')
							.load('rose.obj', function (group) {
								mesh0 = group.children[0];
								mesh0.material.side = THREE.DoubleSide;
								mesh0.position.y = 0.25;
								mesh0.scale.set(0.25, 0.25, 0.25);
								markerRoot.add(mesh0);
							}, onProgress, onError);
					});

			}
		}

		function onProgress(xhr) { console.log((xhr.loaded / xhr.total * 100) + '% loaded'); }
		function onError(xhr) { console.log('An error happened'); }

		function update() {
			// update artoolkit on every frame
			if (arToolkitSource.ready !== false)
				arToolkitContext.update(arToolkitSource.domElement);
		}


		function render() {
			renderer.render(scene, camera);
		}


		function animate() {
			requestAnimationFrame(animate);
			deltaTime = clock.getDelta();
			totalTime += deltaTime;
			update();
			render();
		}

		function open360Image() {
			document.getElementById("viewer").style.display = '';
			if (!viewer) {
				viewer = new PhotoSphereViewer({
					container: 'viewer',
					panorama:
						'https://photo-sphere-viewer.js.org/assets/Bryce-Canyon-National-Park-Mark-Doliner.jpg',
					navbar: ['autorotate', 'zoom', 'fullscreen']
				});
			}

		}
		function closeImage() {
			document.getElementById("viewer").style.display = "none";

		}
	</script>
	<button style="right:0;bottom:0;z-index: 2;" id="open360" class="ui" onclick="open360Image()">OPEN 360
		IMAGE</button>
	<button style="bottom:0;z-index: 2" id="closeImage" class="ui" onclick="closeImage()">Close IMAGE</button>

	<div id="viewer"></div>

</body>

</html>